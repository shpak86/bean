# Bean — Система анализа поведенческих метрик

Bean — это легковесный сервис для сбора, хранения и анализа поведенческих метрик пользователей. Он позволяет выявлять и классифицировать автоматизированное поведение на основе настраиваемых правил.

## Обзор

На стороне клиента JS-скрипт собирает поведенческие метрики пользователя (трейсы) и регулярно отправляет их на сервер. На сервере метрики агрегируются и вычисляется score, позволяющий классифицировать действия пользователя. Классификация выполняется на основе гибких правил обработки трейсов. Сервер предоставляет REST API, позволяющий запросить score по идентификатору пользователя.

## Метрики

Скрипт собирает следующие метрики:

- **timestamp** (string) — временная метка события в формате ISO 8601, указывающая, когда был зафиксирован трейс.
- **mouseMoves** (int) — общее количество зафиксированных движений мыши за сессию.
- **clicks** (int) — общее количество кликов (левых, правых, средних) за сессию.
- **clickTimingMin** (int) — минимальное время (в миллисекундах) между последовательными кликами.
- **clickTimingMax** (int) — максимальное время (в миллисекундах) между последовательными кликами.
- **clickTimingAvg** (int) — среднее время (в миллисекундах) между кликами за сессию.
- **clickTimingCount** (int) — количество измеренных интервалов между кликами (полезно для нормализации avg).
- **scrolls** (int) — общее количество событий прокрутки (колесико, тач, клавиши) за сессию.
- **scrollTimingMin** (int) — минимальное время (в мс) между событиями прокрутки.
- **scrollTimingMax** (int) — максимальное время (в мс) между событиями прокрутки.
- **scrollTimingAvg** (int) — среднее время (в мс) между событиями прокрутки.
- **scrollTimingCount** (int) — количество зарегистрированных интервалов прокрутки.
- **textInputEvents** (int) — количество событий ввода текста (keydown, input и т. п.).
- **textInputTimingMin** (int) — минимальное время (в мс) между символами при вводе.
- **textInputTimingMax** (int) — максимальное время (в мс) между символами при вводе.
- **textInputTimingAvg** (int) — средняя скорость ввода (в мс на символ).
- **textInputTimingCount** (int) — количество зарегистрированных интервалов ввода (пар нажатий).
- **sessionDuration** (int) — длительность сессии в миллисекундах с момента её начала.
- **userAgent** (string) — строка User-Agent браузера, содержащая информацию о клиенте.
- **language** (string) — предпочитаемый язык браузера (например, «ru-RU», «en-US»).
- **platform** (string) — платформа устройства (например, «Win32», «Linux x86_64», «MacIntel»).
- **screenWidth** (int) — ширина экрана устройства в пикселях.
- **screenHeight** (int) — высота экрана устройства в пикселях.
- **timezone** (string) — часовой пояс клиента в формате IANA (например, «Europe/Moscow»).
- **cookiesEnabled** (bool) — флаг, указывающий, включены ли куки в браузере.
- **onLine** (bool) — флаг сетевого статуса: true, если браузер считает, что подключён к интернету.
- **deviceMemory** (int) — объём оперативной памяти устройства в гигабайтах (оценка, доступна не во всех браузерах).
- **maxTouchPoints** (int) — максимальное количество одновременных точек касания (0 — нет тач-экрана; 1 и более — тач-устройство).
- **browserName** (string) — имя браузера (например, «Chrome», «Firefox», «Safari»).
- **browserVersion** (string) — версия браузера (например, «125.0.0»).
- **osName** (string) — название операционной системы (например, «Windows», «Android», «iOS»).
- **osVersion** (string) — версия операционной системы (например, «10», «14.5»).

Клиент однозначно идентифицируется по одной из cookie. Скрипт отправляет метрики с браузерными cookie; для корректной обработки метрик на стороне сервера необходимо настроить имя cookie, из которой берётся идентификатор клиента.

## API

Сервис предоставляет следующие REST API:

- **POST /api/v1/traces** — приём нового трейса
- **GET /api/v1/scores/{token}** — получение оценки по токену
- **GET /static/...** — раздача статических файлов (если включено)

## Сборка

### Server

```bash
# Сборка
go build -o bean cmd/bean/main.go

# Запуск
./bean --config config.yaml
```

### Script

Скрипт может быть встроен на страницу через тег:

```html
<script src="/static/collector.js"></script>
```

После этого необходимо создать экземпляр сборщика:

```js
const collector = new BehavioralMetricsCollector({
    enableLogging: false,   
    reportInterval: 5000,
    skipEmpty: true,
    address: "/api/v1/traces",
});
```

## Конфигурация

Bean настраивается через YAML-файл конфигурации. Ниже приведено подробное описание всех параметров, их назначения и допустимых значений.

### Общая структура

```yaml
logger:
  level: info

server:
  address: ":8080"
  static: "./public"

analysis:
  token: token
  traces_length: 10
  traces_ttl: 10m
  scorers:
    - type: ml
      model: default
      url: http://127.0.0.1:8000
    - type: rules
      rules: /etc/bean/rules.yaml

dataset:
  file: /var/log/bean/dataset.log
  size: 1024
  amount: 10
```

### logger

Настройки компонента логирования.

#### level (обязательный)

Уровень детализации логов. Поддерживаемые значения (без учёта регистра):
- debug — подробные логи для разработки
- info — информационные сообщения (по умолчанию)
- warn или warning — предупреждения
- error — только критические ошибки

### server

Параметры HTTP-сервера.

#### address (обязательный)

Адрес и порт, на котором будет запущен сервер. Используйте :8080, чтобы слушать все интерфейсы на порту 8080.

#### static

Путь к директории со статическими файлами (например, collector.js). Если указан, файлы будут доступны по маршруту /static/.
Можно оставить пустым, если раздача статики не требуется.

### analysis

Настройки поведенческого анализа.

#### token (обязательный)

Имя cookie, используемое для идентификации сессии. Bean ожидает, что клиент (браузер) отправляет эту cookie в каждом запросе с трейсом. Это не секрет, а просто ключ для связывания данных сессии.

#### scorers (обязательный)

Список scorers выполняющих анализ. Scorers выполняют анализ в том порядке, в котором они указаны. Возможные типы: ML и rule scorer.
Пример:

```yaml
- type: ml
  model: default
  url: http://127.0.0.1:8000

- type: rules
  rules: /etc/bean/rules.yaml
```

Для ML scorer необходимо указать URL сервиса инференса и имя модели. Для rule необходимо указать путь к файлу с правилами. Файл должен существовать и содержать корректные правила на языке CEL.

#### traces_length

Максимальное количество хранимых трейсов на одну сессию. При превышении старые трейсы удаляются (FIFO). Рекомендуемое значение: 20–100, в зависимости от частоты отправки.

#### traces_ttl

Время, после которого сессия считается неактивной и удаляется из памяти.

Поддерживаемые единицы:
- s — секунды
- m — минуты
- h — часы

### dataset

Настройки сбора датасета. Если указан этот параметр, то будет все принятые trace будут записываться в dataset. Dataset ротируется, обратите внимание на дефолтные параметры.

#### file

Путь к файлу для записи dataset.

#### size

Максимальный размер файла. По умолчанию 100МБ.

#### amount

Количество хранимых файлов. По умолчанию хранится 20 последних датасетов.

### Переменные окружения

Bean автоматически поддерживает переопределение параметров через переменные окружения. Приоритет: переменные окружения > значения в YAML. Имена переменных формируются по шаблону:

```bash
LOGGER_LEVEL=debug
SERVER_ADDRESS=:9090
ANALYSIS_TRACES_TTL=30m
```

### Проверка конфигурации

Bean проверяет конфигурацию при запуске:

- Все обязательные поля должны быть указаны.
- Уровень логирования должен быть допустимым.
- Файл правил должен существовать.
- При ошибке запуск останавливается с описанием проблемы.

Используйте `bean --config config.yaml` для загрузки конфига из файла.

## Правила

Bean использует **Common Expression Language (CEL)** для описания правил поведенческого анализа. Правила позволяют оценивать действия пользователя и выставлять баллы за признаки поведения (например, автоматизация, боты).

При запросе оценки анализируются все собранные трейсы и выставляются score. Если трейс удовлетворяет правилу, то оценки изменяются на указанные величины.

### Формат файла правил

Правила задаются в **YAML-файле**, который загружается при старте сервера. Файл содержит список правил, каждое правило состоит из условия и приращения оценок:

- when — условие на языке CEL (должно возвращать true или false)
- then — объект с оценками, которые будут добавлены к итоговому результату

```yaml
- when: mouseMoves > 10 && clicks > 5
  then:
    human: 0.3
    automation: -0.1

- when: deviceMemory < 2
  then:
    automation: 0.2
```

### Переменные

В выражениях when можно использовать следующие переменные:

| Метрика | Тип | Описание |
|---------|-----|---------|
| mouseMoves | int | Количество движений мыши |
| clicks | int | Количество кликов |
| clickTimingMin | int | Минимальная задержка между кликами (мс) |
| clickTimingMax | int | Максимальная задержка между кликами (мс) |
| clickTimingAvg | int | Средняя задержка между кликами (мс) |
| clickTimingCount | int | Количество измеренных интервалов кликов |
| scrolls | int | Количество прокруток |
| scrollTimingMin | int | Минимальная задержка между прокрутками |
| scrollTimingMax | int | Максимальная задержка между прокрутками |
| scrollTimingAvg | int | Средняя задержка между прокрутками |
| scrollTimingCount | int | Количество измеренных интервалов прокрутки |
| textInputEvents | int | Количество событий ввода текста |
| textInputTimingMin | int | Минимальная задержка между символами |
| textInputTimingAvg | int | Средняя задержка между символами |
| textInputTimingMax | int | Максимальная задержка между символами |
| textInputTimingCount | int | Количество измеренных интервалов ввода |
| sessionDuration | int | Длительность сессии (мс) |
| userAgent | string | Полная строка User-Agent |
| language | string | Язык браузера (например, ru-RU) |
| platform | string | Платформа (например, Win32) |
| screenWidth | int | Ширина экрана (px) |
| screenHeight | int | Высота экрана (px) |
| timezone | string | Часовой пояс (например, Europe/Moscow) |
| cookiesEnabled | bool | Включены ли куки |
| onLine | bool | Статус подключения к интернету |
| deviceMemory | int | Оценка RAM в ГБ |
| maxTouchPoints | int | Максимальное число точек касания |
| browserName | string | Имя браузера (Chrome, Firefox и т. д.) |
| browserVersion | string | Версия браузера |
| osName | string | Название ОС (Windows, Android и т. д.) |
| osVersion | string | Версия ОС |

### Синтаксис выражений (CEL)

#### Условия (when)

Если условие when возвращает true, Bean добавляет указанные оценки к итоговому результату. Условия используют синтаксис CEL. CEL поддерживает:

- Арифметические операции: `+`, `-`, `*`, `/`, `%`
- Логические операции: `&&`, `||`, `!`
- Сравнения: `==`, `!=`, `<`, `>`, `<=`, `>=`
- Методы работы с текстом: `browserName == "Chrome"`, `language.startsWith("en")` и т. д.

Подробно о CEL: https://github.com/google/cel-spec

#### Оценки (then)

Каждая оценка — это ключ (строка) и значение от 0.0 до 1.0.
Все оценки суммируются по ключам, но ограничиваются диапазоном [0.0, 1.0].

### Примеры правил

1. Подозрительное отсутствие активности

```yaml
- when: mouseMoves < 3 && sessionDuration > 30000
  then:
    inactive: 0.8
```

2. Быстрый ввод текста

```yaml
- when: textInputTimingAvg < 80 && textInputEvents > 5
  then:
    automation: 0.7
```

3. Устройство с маленькой памятью

```yaml
- when: deviceMemory < 2
  then:
    device: 0.6
```

4. Отсутствие прокрутки

```yaml
- when: scrolls == 0 && sessionDuration > 10000
  then:
    automation: 0.5
```

5. Headless Chrome

```yaml
- when: browserName.contains("HeadlessChrome")
  then:
    automation: 1.0
```

### Важные моменты

- Правила применяются к каждому трейсу — если пользователь отправил 10 трейсов, каждое правило проверяется 10 раз.
- Оценки накапливаются — если два правила сработали, их then-значения суммируются.
- Максимальное значение по ключу — 1.0 — оценка не может превысить 1.0 (насыщение).
- Ошибка в выражении — приводит к пропуску правила (не останавливает анализ).
- Порядок правил — не важен, но рекомендуется группировать по логике.